version: '3.1'

services:

  db:
    image: pharmacollect/mariadb:v0.0.1
    restart: always
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
    volumes:
      - /home/ph-admin/PharmaCollect/mariadb_data:/var/lib/mysql
      - /home/ph-admin/PharmaCollect/mariadb_config/ssl:/etc/ssl/mariadb
      - /home/ph-admin/PharmaCollect/mariadb_config/my.cnf:/etc/mysql/my.cnf
    ports:
      - 3306:3306    
  
  phpmyadmin:
    image: pharmacollect/phpmyadmin:v0.0.1
    restart: always
    ports:
      - 6443:443
    volumes:
      - /home/ph-admin/PharmaCollect/phpmyadmin_data/config.inc.php:/etc/phpmyadmin/config.inc.php
      - /home/ph-admin/PharmaCollect/phpmyadmin_data/config.user.inc.php:/etc/phpmyadmin/config.user.inc.php
      - /home/ph-admin/PharmaCollect/phpmyadmin_data/cert:/etc/ssl/phpmyadmin
      - /home/ph-admin/PharmaCollect/phpmyadmin_data/000-default.conf:/etc/apache2/sites-available/000-default.conf
      - /home/ph-admin/PharmaCollect/phpmyadmin_data/log:/var/log/apache2/

  node-http:
    image: pharmacollect/node:latest
    restart: always
    ports:
      - 8082:3000
    labels:
      - "traefik.http.routers.node.rule=Host(`nodehttp.docker.localhost`)"
    command: node /usr/src/app/server.js

  node-https:
    image: pharmacollect/node:latest
    restart: always
    ports:
      - 8083:3000
    volumes:
      - /home/ph-admin/PharmaCollect/cert:/etc/ssl
    labels:
      - "traefik.http.routers.node.rule=Host(`nodehttps.docker.localhost`)"
    command: node /usr/src/app/server_https.js
  
  reverse-proxy:
    # The official v2 Traefik docker image
    image: traefik:v2.3
    # Enables the web UI and tells Traefik to listen to docker
    command: --api.insecure=true --providers.docker
    ports:
      # The HTTP port
      - "80:80"
      # The Web UI (enabled by --api.insecure=true)
      - "8081:8080"
    volumes:
      # So that Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock
    
    labels:
      - "traefik.http.routers.dashboard.rule=Host(`pharmacollect.freeboxos.fr`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=test:$$apr1$$H6uskkkW$$IgXLP6ewTrSuBkTrqE8wj/,test2:$$apr1$$d9hr9HBB$$4HxwgUir3HP4EsggP/QNo0"
